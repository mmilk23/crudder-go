# .github/workflows/compose-smoke.yml
name: Compose Smoke Test

on:
  pull_request:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"
      - "docker-compose.yaml"
      - "init.sql"
      - ".env.example"
      - ".github/workflows/compose-smoke.yml"
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"
      - "docker-compose.yaml"
      - "init.sql"
      - ".env.example"
      - ".github/workflows/compose-smoke.yml"
  workflow_dispatch:

concurrency:
  group: compose-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest

    env:
      DOCKER_BUILDKIT: "1"
      COMPOSE_DOCKER_CLI_BUILD: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Show docker versions
        run: |
          docker version
          docker compose version

      - name: Validate docker compose
        run: docker compose config -q

      - name: Build and start (wait for healthchecks)
        run: |
          set -euo pipefail

          # Usa --wait (compose v2) para aguardar healthcheck do MySQL.
          # Se por algum motivo não estiver disponível, o comando falha e a etapa aborta mesmo.
          docker compose up -d --build --wait --wait-timeout 180

      - name: Show containers
        run: |
          docker compose ps
          docker ps -a

      - name: Wait for app HTTP
        run: |
          set -euo pipefail

          for i in {1..60}; do
            if curl -fsS http://localhost:8080/login >/dev/null 2>&1; then
              echo "App is responding"
              exit 0
            fi

            # Falha cedo se algum serviço morrer
            if ! docker compose ps --status running | grep -qE '^\s*mysql\s'; then
              echo "MySQL is not running anymore"
              docker compose ps
              echo "---- mysql logs (tail) ----"
              docker compose logs --no-color --tail=300 mysql || true
              exit 1
            fi

            if ! docker compose ps --status running | grep -qE '^\s*crudder\s'; then
              echo "Crudder is not running anymore"
              docker compose ps
              echo "---- crudder logs (tail) ----"
              docker compose logs --no-color --tail=300 crudder || true
              exit 1
            fi

            sleep 2
          done

          echo "Timed out waiting for app"
          docker compose ps
          docker compose logs --no-color
          exit 1

      - name: Logs (mysql) on failure
        if: failure()
        run: docker compose logs --no-color --tail=300 mysql

      - name: Logs (crudder) on failure
        if: failure()
        run: docker compose logs --no-color --tail=300 crudder

      - name: Debug containers on failure
        if: failure()
        run: |
          docker ps -a
          docker inspect crudder_mysql || true
          docker inspect crudder_app || true

      - name: Teardown
        if: always()
        run: docker compose down -v --remove-orphans
