# .github/workflows/compose-smoke.yml
name: Compose Smoke Test

on:
  pull_request:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"
      - "docker-compose.yaml"
      - "init.sql"
      - "my.cnf"
  workflow_dispatch:

concurrency:
  group: compose-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate docker compose
        run: docker compose config -q

      - name: Build and start
        run: docker compose up -d --build

      - name: Show containers
        run: docker compose ps

      # Espera o app responder HTTP (o check "de verdade")
      - name: Wait for app HTTP
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/login >/dev/null 2>&1; then
              echo "App is responding"
              exit 0
            fi
            sleep 2
          done
          echo "Timed out waiting for app"
          docker compose ps
          docker compose logs --no-color
          exit 1

      - name: Teardown
        if: always()
        run: docker compose down -v
