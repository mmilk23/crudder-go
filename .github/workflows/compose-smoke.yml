# .github/workflows/compose-smoke.yml
name: Compose Smoke Test

on:
  pull_request:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"
      - "docker-compose.yaml"
      - "init.sql"
      - ".env.example"
      - ".github/workflows/compose-smoke.yml"
  push:
    branches: ["main"]
    paths:
      - "Dockerfile"
      - "docker-compose.yml"
      - "docker-compose.yaml"
      - "init.sql"
      - ".env.example"
      - ".github/workflows/compose-smoke.yml"
  workflow_dispatch:

concurrency:
  group: compose-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest

    env:
      DOCKER_BUILDKIT: "1"
      COMPOSE_DOCKER_CLI_BUILD: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Show docker versions
        run: |
          docker version
          docker compose version

      - name: Validate docker compose
        run: docker compose config -q

      - name: Build and start (wait for healthchecks)
        run: |
          set -euo pipefail
          # --wait aguarda serviços com healthcheck (no seu compose, MySQL).
          docker compose up -d --build --wait --wait-timeout 180

      - name: Show containers
        run: |
          docker compose ps
          docker ps -a
          echo "---- port mapping (crudder) ----"
          docker port crudder_app || true

      - name: Wait for app HTTP (IPv4, robust)
        run: |
          set -euo pipefail

          URL="http://127.0.0.1:9091/login"

          # Opcional: mostra rapidamente o estado inicial
          echo "Probing: $URL"
          echo "---- initial ps ----"
          docker compose ps

          for i in {1..60}; do
            # http_code=000 => não conectou
            code="$(curl -4 -sS -o /dev/null -w "%{http_code}" "$URL" || true)"
            if [[ "$code" != "000" ]]; then
              echo "App is responding (HTTP $code)"
              # Se quiser ser estrito: descomente abaixo e exija 200
              # [[ "$code" == "200" ]] || (echo "Unexpected HTTP $code" && exit 1)
              exit 0
            fi

            # Falha cedo se algum serviço morrer (checa SERVICES, não nome de container)
            if ! docker compose ps --services --filter "status=running" | grep -qx mysql; then
              echo "MySQL is not running anymore"
              docker compose ps
              echo "---- mysql logs (tail) ----"
              docker compose logs --no-color --tail=300 mysql || true
              exit 1
            fi

            if ! docker compose ps --services --filter "status=running" | grep -qx crudder; then
              echo "Crudder is not running anymore"
              docker compose ps
              echo "---- crudder logs (tail) ----"
              docker compose logs --no-color --tail=300 crudder || true
              exit 1
            fi

            # A cada 10 tentativas, mostra um status resumido pra facilitar debug
            if (( i % 10 == 0 )); then
              echo "Still waiting... attempt=$i"
              docker compose ps
              echo "---- crudder logs (tail=80) ----"
              docker compose logs --no-color --tail=80 crudder || true
            fi

            sleep 2
          done

          echo "Timed out waiting for app"
          docker compose ps
          echo "---- crudder logs (tail) ----"
          docker compose logs --no-color --tail=300 crudder || true
          echo "---- mysql logs (tail) ----"
          docker compose logs --no-color --tail=200 mysql || true
          exit 1

      - name: Logs (mysql) on failure
        if: failure()
        run: docker compose logs --no-color --tail=300 mysql

      - name: Logs (crudder) on failure
        if: failure()
        run: docker compose logs --no-color --tail=300 crudder

      - name: Debug containers on failure
        if: failure()
        run: |
          docker ps -a
          docker inspect crudder_mysql || true
          docker inspect crudder_app || true

      - name: Teardown
        if: always()
        run: docker compose down -v --remove-orphans
